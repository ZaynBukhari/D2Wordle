<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Destiny 2 Wordle</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        #search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #guns-list {
            list-style-type: none;
            padding: 0;
        }
        #guns-list li {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            transition: background-color 0.3s;
        }
        #guns-list li:hover {
            background-color: #f9f9f9;
        }
        .icon-container {
            position: relative;
            width: 96px;
            height: 96px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .weapon-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .watermark-icon {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .result-header {
            margin: 20px 0 10px 0;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }
        .result {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
        }
        .result .icon-container {
            position: relative;
            width: 96px;
            height: 96px;
            margin-right: 20px;
            flex-shrink: 0;
        }
        .result .weapon-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .result .watermark-icon {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .result div {
            flex-grow: 1;
        }
        .result p {
            margin: 0;
            padding: 5px 0;
            color: #333;
        }
        .info-section {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .info-box {
            flex: 1;
            text-align: center;
            padding: 10px;
            margin: 0 5px;
            border-radius: 5px;
        }
        .info-box.correct {
            background-color: green;
            color: white;
        }
        .info-box.wrong {
            background-color: red;
            color: white;
        }
        #win-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #win-screen {
            background-color: #fff;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
        }
        .copy-btn, .close-btn {
            padding: 10px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .copy-btn {
            background-color: #4CAF50;
        }
        .close-btn {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Destiny 2 Wordle</h1>
        <input type="text" id="search-bar" placeholder="Search for a gun">
        <ul id="guns-list"></ul>
        <div id="result"></div>
        <div id="win-modal">
            <div id="win-screen">
                <h2 id="win-message"></h2>
                <pre id="result-pattern"></pre>
                <button class="copy-btn" onclick="copyPattern()">Copy Result</button>
                <button class="close-btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let gunsData = [];
        let attempts = 0;
        const maxAttempts = 6;
        let resultPattern = '';

        async function fetchGuns() {
            try {
                const response = await fetch('/api/guns');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                gunsData = await response.json();
                return gunsData;
            } catch (error) {
                console.error('Error fetching guns:', error);
            }
        }

        async function setTargetGun() {
            try {
                const response = await fetch('/api/set_target_gun');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const targetGun = await response.json();
                console.log('Target Gun Set:', targetGun);
            } catch (error) {
                console.error('Error setting target gun:', error);
            }
        }

        async function compareGun(guessedGunId) {
            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ guessed_gun_id: guessedGunId })
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const result = await response.json();
                console.log('Comparison result:', result);
                return result;
            } catch (error) {
                console.error('Error comparing guns:', error);
            }
        }

        function updateGunList(searchTerm) {
            const filteredGuns = gunsData.filter(gun => gun.name.toLowerCase().includes(searchTerm));
            const gunsList = document.getElementById('guns-list');
            gunsList.innerHTML = '';
            filteredGuns.forEach(gun => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="icon-container">
                        <img src="https://www.bungie.net${gun.icon}" alt="${gun.name}" class="weapon-icon">
                        ${gun.iconWatermark ? `<img src="https://www.bungie.net${gun.iconWatermark}" alt="Watermark" class="watermark-icon">` : ''}
                    </div>
                    ${gun.name}
                `;
                li.addEventListener('click', async function() {
                    if (attempts < maxAttempts) {
                        const result = await compareGun(gun.hash);
                        const resultDiv = document.getElementById('result');
                        attempts++;
                        let attemptPattern = '';

                        resultDiv.innerHTML += `
                            <div class="result-header">${result.name}</div>
                            <div class="result">
                                <div class="icon-container">
                                    <img src="https://www.bungie.net${result.icon}" alt="${result.name}" class="weapon-icon">
                                    ${result.iconWatermark ? `<img src="https://www.bungie.net${result.iconWatermark}" alt="Watermark" class="watermark-icon">` : ''}
                                </div>
                                <div class="info-section">
                                    <div class="info-box ${result.weaponType.correct ? 'correct' : 'wrong'}">Weapon Type: ${result.weaponType.actual}</div>
                                    <div class="info-box ${result.archetype.correct ? 'correct' : 'wrong'}">Archetype: ${result.archetype.actual}</div>
                                    <div class="info-box ${result.damageType.correct ? 'correct' : 'wrong'}">Damage Type: ${result.damageType.actual}</div>
                                    <div class="info-box ${result.ammoType.correct ? 'correct' : 'wrong'}">Ammo Type: ${result.ammoType.actual}</div>
                                    <div class="info-box ${result.craftable.correct ? 'correct' : 'wrong'}">Craftable: ${result.craftable.actual ? 'Yes' : 'No'}</div>
                                </div>
                            </div>
                        `;

                        attemptPattern += result.weaponType.correct ? '游릴' : '游린';
                        attemptPattern += result.archetype.correct ? '游릴' : '游린';
                        attemptPattern += result.damageType.correct ? '游릴' : '游린';
                        attemptPattern += result.ammoType.correct ? '游릴' : '游린';
                        attemptPattern += result.craftable.correct ? '游릴' : '游린';
                        resultPattern += `${attemptPattern}\n`;

                        if (result.weaponType.correct && result.archetype.correct && result.damageType.correct && result.ammoType.correct && result.craftable.correct) {
                            showWinScreen(true);
                        } else if (attempts >= maxAttempts) {
                            showWinScreen(false);
                        }
                    }
                });
                gunsList.appendChild(li);
            });
        }

        function showWinScreen(won) {
            const winModal = document.getElementById('win-modal');
            const winMessage = document.getElementById('win-message');
            const resultPatternElement = document.getElementById('result-pattern');

            winModal.style.display = 'flex';
            winMessage.textContent = won ? `You won in ${attempts} attempts!` : 'You ran out of attempts!';
            resultPatternElement.textContent = `D2Wordle ${attempts}/${maxAttempts}\n\n${resultPattern}`;
        }

        function closeModal() {
            document.getElementById('win-modal').style.display = 'none';
        }

        function copyPattern() {
            const resultPatternElement = document.getElementById('result-pattern');
            navigator.clipboard.writeText(resultPatternElement.textContent).then(() => {
                alert('Result pattern copied to clipboard');
            });
        }

        document.getElementById('search-bar').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            updateGunList(searchTerm);
        });

        fetchGuns().then(() => {
            setTargetGun();
        });
    </script>
</body>
</html>
